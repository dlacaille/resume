name: Release LaTeX document

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
jobs:
  build_latex:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸƒâ€â™‚ï¸â€â¡ï¸ Checkout repository (fetch tags only)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
    
      - name: ğŸ·ï¸ Determine tag name
        id: tag
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG_NAME="${GITHUB_REF#refs/tags/}"
          else
            TAG_NAME=$(git tag | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n 1)
          fi
          echo "ğŸ·ï¸ Using tag: $TAG_NAME"
          echo "tag_name=$TAG_NAME" >> "$GITHUB_OUTPUT"
          
      - name: ğŸ—ƒï¸ Set up Git repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.tag.outputs.tag_name }}
        
      - name: ğŸ“ Compile LaTeX documents
        uses: xu-cheng/latex-action@v3
        with:
          root_file: dominic-lacaille-cv-??.tex
          latexmk_use_lualatex: true
          
      - name: ğŸ’ Install Poppler (for PDF screenshots)
        run: sudo apt-get update && sudo apt-get install -y poppler-utils

      - name: ğŸ“· Generate PNG screenshot of first page
        run: |
          for pdf in dominic-lacaille-cv-*.pdf; do
            output="screenshot-${pdf%.pdf}.png"
            pdftoppm -png -f 1 -singlefile "$pdf" "${output%.png}"
            echo "ğŸ“· Generated screenshot: $output"
          done

      - name: â˜‘ï¸ Ensure release exists
        run: |
          TAG=${{ steps.tag.outputs.tag_name }}
          if ! gh release view "$TAG" > /dev/null 2>&1; then
            echo "ğŸ“ Creating GitHub release for tag $TAG"
            gh release create "$TAG" --title "$TAG" --notes "Automated release for $TAG"
          else
            echo "â˜‘ï¸ Release for tag $TAG already exists"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ“‹ Upload PDFs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: cv-preview-pdfs
          path: dominic-lacaille-cv-*.pdf

      - name: ğŸšš Upload PDFs to GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          files: |
            dominic-lacaille-cv-*.pdf
            screenshot-dominic-lacaille-cv-*.png
          fail_on_unmatched_files: true
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
